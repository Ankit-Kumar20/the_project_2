import type { NextPage } from "next";
import Head from "next/head";
import Link from "next/link";
import { useRouter } from "next/router";
import { useSession, signOut } from "@/lib/auth-client";
import { useState, useEffect } from "react";
import styles from "../styles/Home.module.css";
import { useTheme } from "@/lib/theme-context";
import { Moon, Sun } from "@phosphor-icons/react";

interface Trip {
  id: string;
  name: string;
  destinations: string;
  startDate: string | null;
  endDate: string | null;
  travellers: string | null;
  pace: string | null;
  budget: string | null;
  interests: string | null;
  createdAt: string;
  fromLocation?: string;
  toLocation?: string;
  days?: number;
  stops?: string;
}

const Home: NextPage = () => {
  const { data: session, isPending } = useSession();
  const { theme, toggleTheme } = useTheme();
  const router = useRouter();
  const [name, setName] = useState("");
  const [destinations, setDestinations] = useState("");
  const [startDate, setStartDate] = useState("");
  const [endDate, setEndDate] = useState("");
  const [travellers, setTravellers] = useState("");
  const [pace, setPace] = useState("balanced");
  const [budget, setBudget] = useState("");
  const [interests, setInterests] = useState("");
  const [mustSees, setMustSees] = useState("");
  const [avoid, setAvoid] = useState("");
  const [mobilityConstraints, setMobilityConstraints] = useState("");
  const [travelModes, setTravelModes] = useState("");
  const [loading, setLoading] = useState(false);
  const [showModal, setShowModal] = useState(false);
  const [trips, setTrips] = useState<Trip[]>([]);
  const [loadingTrips, setLoadingTrips] = useState(false);

  useEffect(() => {
    if (session?.user) {
      fetchTrips();
    }
  }, [session]);

  const fetchTrips = async () => {
    setLoadingTrips(true);
    try {
      const response = await fetch("/api/trips/list");
      const result = await response.json();
      if (result.success) {
        setTrips(result.trips);
      }
    } catch (error) {
      console.error("Error fetching trips:", error);
    } finally {
      setLoadingTrips(false);
    }
  };

  const handleSignOut = async () => {
    await signOut();
  };

  const handleCreateTrip = async () => {
    setLoading(true);
    try {
      const response = await fetch("/api/trips/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          name,
          destinations,
          startDate,
          endDate,
          travellers,
          pace,
          budget,
          interests,
          mustSees,
          avoid,
          mobilityConstraints,
          travelModes,
        }),
      });

      const result = await response.json();

      if (result.success) {
        setShowModal(false);
        setName("");
        setDestinations("");
        setStartDate("");
        setEndDate("");
        setTravellers("");
        setPace("balanced");
        setBudget("");
        setInterests("");
        setMustSees("");
        setAvoid("");
        setMobilityConstraints("");
        setTravelModes("");
        fetchTrips();
        router.push(`/canvas?tripId=${result.tripId}`);
      } else {
        alert("Failed to generate travel flow");
      }
    } catch (error) {
      console.error("Error:", error);
      alert("An error occurred");
    } finally {
      setLoading(false);
    }
  };

  const handleViewTrip = (tripId: string) => {
    router.push(`/canvas?tripId=${tripId}`);
  };

  const handleDeleteTrip = async (
    tripId: string,
    tripName: string,
    e: React.MouseEvent
  ) => {
    e.stopPropagation();

    if (!confirm(`Are you sure you want to delete "${tripName}"?`)) {
      return;
    }

    try {
      const response = await fetch("/api/trips/delete", {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: tripId }),
      });

      const result = await response.json();

      if (result.success) {
        fetchTrips();
      } else {
        alert("Failed to delete trip");
      }
    } catch (error) {
      console.error("Error deleting trip:", error);
      alert("An error occurred while deleting");
    }
  };

  return (
    <div className={styles.container}>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <main className={styles.main}>
        <div className="absolute top-[20px] right-[20px]">
          <button
            onClick={toggleTheme}
            className="p-[10px] rounded-[24px] border-[1.5px] cursor-pointer flex items-center justify-center transition-all duration-200"
            style={{
              backgroundColor: "var(--hover-bg)",
              borderColor: "var(--border-color)",
            }}
            title={`Switch to ${theme === "light" ? "dark" : "light"} mode`}
          >
            {theme === "light" ? (
              <Moon size={20} weight="regular" color="var(--text-primary)" />
            ) : (
              <Sun size={20} weight="regular" color="var(--text-primary)" />
            )}
          </button>
        </div>
        <h1 className={styles.title}>Welcome to Next.js on Replit!</h1>

        {isPending ? (
          <p className={styles.description}>Loading...</p>
        ) : session?.user ? (
          <div>
            <p className={styles.description}>
              Welcome,{" "}
              {String(session.user.name || session.user.email || "User")}!
            </p>
            <div className="mt-[20px] flex gap-[10px] justify-center">
              <button
                onClick={() => setShowModal(true)}
                className="px-[30px] py-[12px] text-[16px] bg-[#0070f3] text-white border-none rounded-[24px] cursor-pointer font-semibold"
              >
                New Trip
              </button>
              <button
                onClick={handleSignOut}
                className="px-[20px] py-[10px] text-[16px] bg-[#ff0000] text-white border-none rounded-[24px] cursor-pointer"
              >
                Sign Out
              </button>
            </div>

            {/* Trips List */}
            <div className="mt-[40px] max-w-[800px] mx-auto my-[40px]">
              <h2
                className="mb-[20px]"
                style={{ color: "var(--text-primary)" }}
              >
                Your Trips
              </h2>
              {loadingTrips ? (
                <p>Loading trips...</p>
              ) : trips.length === 0 ? (
                <p style={{ color: "var(--text-secondary)" }}>
                  No trips yet. Create your first trip!
                </p>
              ) : (
                <div className="grid gap-[15px]">
                  {trips.map((trip) => (
                    <div
                      key={trip.id}
                      onClick={() => handleViewTrip(trip.id)}
                      className="p-[20px] rounded-[24px] border-[1.5px] cursor-pointer transition-all duration-200 relative"
                      style={{
                        backgroundColor: "var(--bg-primary)",
                        borderColor: "var(--border-color)",
                        boxShadow:
                          theme === "light"
                            ? "0 2px 4px rgba(0,0,0,0.05)"
                            : "0 2px 4px rgba(0,0,0,0.3)",
                      }}
                      onMouseEnter={(e) => {
                        e.currentTarget.style.boxShadow =
                          theme === "light"
                            ? "0 4px 12px rgba(0,0,0,0.1)"
                            : "0 4px 12px rgba(0,0,0,0.5)";
                        e.currentTarget.style.borderColor = "#0070f3";
                      }}
                      onMouseLeave={(e) => {
                        e.currentTarget.style.boxShadow =
                          theme === "light"
                            ? "0 2px 4px rgba(0,0,0,0.05)"
                            : "0 2px 4px rgba(0,0,0,0.3)";
                        const borderColor = getComputedStyle(
                          document.documentElement
                        ).getPropertyValue("--border-color");
                        e.currentTarget.style.borderColor = borderColor;
                      }}
                    >
                      <button
                        onClick={(e) => handleDeleteTrip(trip.id, trip.name, e)}
                        className="absolute top-[15px] right-[15px] px-[12px] py-[6px] text-[12px] bg-[#ff4444] text-white border-none rounded-[24px] cursor-pointer font-medium transition-colors duration-200 hover:bg-[#cc0000]"
                      >
                        Delete
                      </button>
                      <h3
                        className="m-0 mb-[10px] pr-[80px]"
                        style={{ color: "var(--text-primary)" }}
                      >
                        {trip.name}
                      </h3>
                      <p
                        className="my-[5px] mx-0 text-[14px]"
                        style={{ color: "var(--text-secondary)" }}
                      >
                        <strong>Route:</strong> {trip.fromLocation} â†’{" "}
                        {trip.toLocation}
                      </p>
                      <p
                        className="my-[5px] mx-0 text-[14px]"
                        style={{ color: "var(--text-secondary)" }}
                      >
                        <strong>Duration:</strong> {trip.days} days
                      </p>
                      {trip.stops && (
                        <p
                          className="my-[5px] mx-0 text-[14px]"
                          style={{ color: "var(--text-secondary)" }}
                        >
                          <strong>Stops:</strong> {trip.stops}
                        </p>
                      )}
                      <p
                        className="mt-[10px] mx-0 mb-0 text-[12px] opacity-70"
                        style={{ color: "var(--text-secondary)" }}
                      >
                        Created: {new Date(trip.createdAt).toLocaleDateString()}
                      </p>
                    </div>
                  ))}
                </div>
              )}
            </div>

            {showModal && (
              <div
                className="fixed top-0 left-0 right-0 bottom-0 bg-black/70 flex justify-center items-center z-[1000]"
                onClick={() => setShowModal(false)}
              >
                <div
                  className="p-[30px] rounded-[24px] max-w-[600px] w-[90%] border-[1.5px]"
                  style={{
                    backgroundColor: "var(--bg-primary)",
                    borderColor: "var(--border-color)",
                    boxShadow:
                      theme === "light"
                        ? "0 4px 20px rgba(0, 0, 0, 0.2)"
                        : "0 4px 20px rgba(0, 0, 0, 0.6)",
                  }}
                  onClick={(e) => e.stopPropagation()}
                >
                  <h2
                    className="mt-0 mb-[20px]"
                    style={{ color: "var(--text-primary)" }}
                  >
                    Plan Your Trip
                  </h2>

                  <div className="mb-[15px]">
                    <input
                      type="text"
                      placeholder="Trip Name (optional)"
                      value={name}
                      onChange={(e) => setName(e.target.value)}
                      className="w-full p-[10px] text-[14px] rounded-[24px] border-[1.5px]"
                      style={{
                        borderColor: "var(--border-color)",
                        backgroundColor: "var(--bg-primary)",
                        color: "var(--text-primary)",
                      }}
                    />
                  </div>

                  <div className="mb-[15px]">
                    <input
                      type="text"
                      placeholder="Destination(s) (e.g., Paris, Rome, Barcelona)"
                      value={destinations}
                      onChange={(e) => setDestinations(e.target.value)}
                      className="w-full p-[10px] text-[14px] rounded-[24px] border-[1.5px]"
                      style={{
                        borderColor: "var(--border-color)",
                        backgroundColor: "var(--bg-primary)",
                        color: "var(--text-primary)",
                      }}
                    />
                  </div>

                  <div className="grid grid-cols-2 gap-[10px] mb-[15px]">
                    <div>
                      <label className="block mb-[5px] text-[12px] text-[#666]">
                        Start Date
                      </label>
                      <input
                        type="date"
                        value={startDate}
                        onChange={(e) => setStartDate(e.target.value)}
                        className="w-full p-[10px] text-[14px] rounded-[5px] border border-[#ccc]"
                      />
                    </div>
                    <div>
                      <label className="block mb-[5px] text-[12px] text-[#666]">
                        End Date
                      </label>
                      <input
                        type="date"
                        value={endDate}
                        onChange={(e) => setEndDate(e.target.value)}
                        className="w-full p-[10px] text-[14px] rounded-[5px] border border-[#ccc]"
                      />
                    </div>
                  </div>

                  <div className="mb-[15px]">
                    <input
                      type="text"
                      placeholder="Number of Travellers (e.g., 2 adults, 1 child)"
                      value={travellers}
                      onChange={(e) => setTravellers(e.target.value)}
                      className="w-full p-[10px] text-[14px] rounded-[24px] border-[1.5px]"
                      style={{
                        borderColor: "var(--border-color)",
                        backgroundColor: "var(--bg-primary)",
                        color: "var(--text-primary)",
                      }}
                    />
                  </div>

                  <div className="mb-[15px]">
                    <label className="block mb-[5px] text-[12px] text-[#666]">
                      Travel Pace
                    </label>
                    <select
                      value={pace}
                      onChange={(e) => setPace(e.target.value)}
                      className="w-full p-[10px] text-[14px] rounded-[5px] border border-[#ccc] bg-white"
                    >
                      <option value="relaxed">Relaxed</option>
                      <option value="balanced">Balanced</option>
                      <option value="packed">Packed</option>
                    </select>
                  </div>

                  <div className="mb-[15px]">
                    <input
                      type="text"
                      placeholder="Budget (e.g., $3000, moderate)"
                      value={budget}
                      onChange={(e) => setBudget(e.target.value)}
                      className="w-full p-[10px] text-[14px] rounded-[24px] border-[1.5px]"
                      style={{
                        borderColor: "var(--border-color)",
                        backgroundColor: "var(--bg-primary)",
                        color: "var(--text-primary)",
                      }}
                    />
                  </div>

                  <div className="mb-[15px]">
                    <input
                      type="text"
                      placeholder="Interests (e.g., food, art, history, adventure)"
                      value={interests}
                      onChange={(e) => setInterests(e.target.value)}
                      className="w-full p-[10px] text-[14px] rounded-[5px] border border-[#ccc]"
                    />
                  </div>

                  <div className="mb-[15px]">
                    <input
                      type="text"
                      placeholder="Must-See Places (optional)"
                      value={mustSees}
                      onChange={(e) => setMustSees(e.target.value)}
                      className="w-full p-[10px] text-[14px] rounded-[24px] border-[1.5px]"
                      style={{
                        borderColor: "var(--border-color)",
                        backgroundColor: "var(--bg-primary)",
                        color: "var(--text-primary)",
                      }}
                    />
                  </div>

                  <div className="mb-[15px]">
                    <input
                      type="text"
                      placeholder="Things to Avoid (optional)"
                      value={avoid}
                      onChange={(e) => setAvoid(e.target.value)}
                      className="w-full p-[10px] text-[14px] rounded-[24px] border-[1.5px]"
                      style={{
                        borderColor: "var(--border-color)",
                        backgroundColor: "var(--bg-primary)",
                        color: "var(--text-primary)",
                      }}
                    />
                  </div>

                  <div className="mb-[15px]">
                    <input
                      type="text"
                      placeholder="Mobility Constraints (optional)"
                      value={mobilityConstraints}
                      onChange={(e) => setMobilityConstraints(e.target.value)}
                      className="w-full p-[10px] text-[14px] rounded-[24px] border-[1.5px]"
                      style={{
                        borderColor: "var(--border-color)",
                        backgroundColor: "var(--bg-primary)",
                        color: "var(--text-primary)",
                      }}
                    />
                  </div>

                  <div className="mb-[20px]">
                    <input
                      type="text"
                      placeholder="Travel Mode Preferences (e.g., train, car, walking)"
                      value={travelModes}
                      onChange={(e) => setTravelModes(e.target.value)}
                      className="w-full p-[10px] text-[14px] rounded-[24px] border-[1.5px]"
                      style={{
                        borderColor: "var(--border-color)",
                        backgroundColor: "var(--bg-primary)",
                        color: "var(--text-primary)",
                      }}
                    />
                  </div>
                  <div className="flex gap-[10px] justify-end">
                    <button
                      onClick={() => setShowModal(false)}
                      className="px-[20px] py-[10px] text-[16px] bg-[#ccc] text-[#333] border-none rounded-[24px] cursor-pointer"
                    >
                      Cancel
                    </button>
                    <button
                      onClick={handleCreateTrip}
                      disabled={loading || !destinations}
                      className="px-[20px] py-[10px] text-[16px] text-white border-none rounded-[24px]"
                      style={{
                        backgroundColor:
                          loading || !destinations ? "#ccc" : "#0070f3",
                        cursor:
                          loading || !destinations ? "not-allowed" : "pointer",
                      }}
                    >
                      {loading ? "Generating..." : "Generate Trip"}
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        ) : (
          <div>
            <p className={styles.description}>
              Please <Link href="/login">sign in</Link> or{" "}
              <Link href="/signup">sign up</Link> to continue.
            </p>
          </div>
        )}
      </main>
    </div>
  );
};

export default Home;
